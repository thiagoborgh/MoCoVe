version: '3.8'

services:
  # Backend Flask
  backend:
    build: .
    container_name: mocove-backend
    ports:
      - "5000:5000"
    environment:
      - DB_PATH=/app/data/memecoin.db
      - USE_TESTNET=true
      - DEBUG=false
      - PORT=5000
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    depends_on:
      - ai-model
    restart: unless-stopped
    networks:
      - mocove-network

  # AI Model Service
  ai-model:
    build: .
    container_name: mocove-ai
    ports:
      - "5001:5000"
    environment:
      - MODEL_PATH=/app/ai/memecoin_rf_model.pkl
      - PORT=5000
    volumes:
      - ./ai:/app/ai
      - ./data:/app/data
    command: ["uvicorn", "ai.ai_model:app", "--host", "0.0.0.0", "--port", "5000"]
    restart: unless-stopped
    networks:
      - mocove-network

  # Data Collector Service
  data-collector:
    build: .
    container_name: mocove-collector
    environment:
      - DB_PATH=/app/data/memecoin.db
      - USE_TESTNET=true
    volumes:
      - ./data:/app/data
      - ./scripts:/app/scripts
    command: ["python", "-c", "
      import time
      import sys
      sys.path.append('/app')
      from scripts.data_collector import DataCollector
      collector = DataCollector()
      while True:
          try:
              collector.run_collection_cycle()
              time.sleep(60)
          except Exception as e:
              print(f'Erro na coleta: {e}')
              time.sleep(30)
    "]
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - mocove-network

  # Nginx (para produção)
  nginx:
    image: nginx:alpine
    container_name: mocove-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./frontend:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - mocove-network

networks:
  mocove-network:
    driver: bridge

volumes:
  mocove-data:
    driver: local
